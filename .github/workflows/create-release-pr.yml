name: Create Release PR

on:
  workflow_dispatch:
    inputs:
      version:
        description: |
          Release version (SemVer X.Y.Z or KSP format X.Y.Z-A.B.C)
          
          Current: 2.2.20-0.0.5 (Old) or 2.3.0 (New)
          Suggested: 2.3.0, 2.3.1 (New Style)
        required: true
        type: string
      base_branch:
        description: 'Target branch for release (e.g., main, 2.2.x, 2.3.x)'
        required: true
        default: 'main'
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  validate:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag_name: ${{ steps.version.outputs.tag_name }}
      branch_name: ${{ steps.version.outputs.branch_name }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      with:
        fetch-depth: 0
        
    - name: Set version variables
      id: version
      run: |
        VERSION="${{ github.event.inputs.version }}"
        TAG_NAME="v${VERSION}"
        BRANCH_NAME="release/${VERSION}"
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "tag_name=${TAG_NAME}" >> $GITHUB_OUTPUT
        echo "branch_name=${BRANCH_NAME}" >> $GITHUB_OUTPUT
        echo "Version: ${VERSION}"
        echo "Tag: ${TAG_NAME}"
        echo "Branch: ${BRANCH_NAME}"
        
    - name: Show latest version and validate format
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        
        # Show current latest version for reference
        LATEST_TAG=$(git tag --sort=-version:refname | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+(-[0-9]+\.[0-9]+\.[0-9]+)?$' | head -1)
        if [ -n "$LATEST_TAG" ]; then
          LATEST_VERSION=$(echo "$LATEST_TAG" | sed 's/^v//')
          echo "ðŸ“‹ Current latest version: ${LATEST_VERSION}"
          
          # Get current Kotlin version from build.gradle.kts
          BUILD_KOTLIN_VERSION=$(grep 'kotlin("jvm") version' build.gradle.kts | sed 's/.*version "\([^"]*\)".*/\1/')
          echo "ðŸ”§ Current build.gradle.kts Kotlin version: ${BUILD_KOTLIN_VERSION}"
          
          echo "ðŸ’¡ Suggested next versions:"
          
          # Check if latest version is SemVer (X.Y.Z) or KSP style (X.Y.Z-A.B.C)
          if [[ $LATEST_VERSION =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            # Current style is SemVer (e.g., 2.3.0)
            MAJOR=$(echo "$LATEST_VERSION" | cut -d'.' -f1)
            MINOR=$(echo "$LATEST_VERSION" | cut -d'.' -f2)
            PATCH=$(echo "$LATEST_VERSION" | cut -d'.' -f3)
            
            NEXT_PATCH="${MAJOR}.${MINOR}.$((PATCH + 1))"
            # If migrating to new Kotlin version (e.g. 2.4.x), start at 2.4.0
            NEXT_KOTLIN_START="${BUILD_KOTLIN_VERSION%.*}.0" 
            
            echo "   ðŸ“¦ Next Patch: ${NEXT_PATCH}"
            if [[ ! "$NEXT_KOTLIN_START" == "$MAJOR.$MINOR.0" ]]; then
                 echo "   ðŸš€ New Kotlin Version: ${NEXT_KOTLIN_START} (if applicable)"
            fi
            
          else
            # Current style is Old KSP style (e.g., 2.2.20-1.0.0)
            echo "   âš ï¸  Detected Old Version Style."
            
            # Suggest converting to New SemVer Style
            # e.g., Kotlin 2.3.20 -> Suggest 2.3.0
            KOTLIN_MAJOR_MINOR=$(echo "$BUILD_KOTLIN_VERSION" | cut -d'.' -f1,2)
            NEW_STYLE_START="${KOTLIN_MAJOR_MINOR}.0"
            
            echo "   ðŸš€ Switch to New Style: ${NEW_STYLE_START}"
            
            # Also suggest old style increment for compatibility
            CURRENT_LIB=$(echo "$LATEST_VERSION" | cut -d'-' -f2)
            LIB_MAJOR=$(echo "$CURRENT_LIB" | cut -d'.' -f1)
            LIB_MINOR=$(echo "$CURRENT_LIB" | cut -d'.' -f2)
            LIB_PATCH=$(echo "$CURRENT_LIB" | cut -d'.' -f3)
            CURRENT_KOTLIN_PART=$(echo "$LATEST_VERSION" | cut -d'-' -f1)
            
            NEXT_OLD_PATCH="${CURRENT_KOTLIN_PART}-${LIB_MAJOR}.${LIB_MINOR}.$((LIB_PATCH + 1))"
            echo "   ðŸ“¦ Old Style Patch: ${NEXT_OLD_PATCH}"
          fi
          echo ""
        else
          echo "ðŸ“‹ No previous releases found - this will be the first release!"
          BUILD_KOTLIN_VERSION=$(grep 'kotlin("jvm") version' build.gradle.kts | sed 's/.*version "\([^"]*\)".*/\1/')
          echo "ðŸ”§ Current build.gradle.kts Kotlin version: ${BUILD_KOTLIN_VERSION}"
          
          # Suggest SemVer style for first release
          KOTLIN_MAJOR_MINOR=$(echo "$BUILD_KOTLIN_VERSION" | cut -d'.' -f1,2)
          echo "ðŸ’¡ Suggested first version: ${KOTLIN_MAJOR_MINOR}.0"
          echo ""
        fi
        
        # Validate input version format (Allow both old KSP format and new SemVer format)
        if [[ ! $VERSION =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[0-9]+\.[0-9]+\.[0-9]+)?$ ]]; then
          echo "âŒ Error: Version validation failed."
          echo "   Input version: ${VERSION}"
          echo "   Expected formats:"
          echo "     1. SemVer (New): KOTLIN_MAJOR.KOTLIN_MINOR.PATCH (e.g., 2.3.0, 2.3.1)"
          echo "     2. KSP format (Old): KOTLIN_VERSION-LIB_VERSION (e.g., 2.2.20-0.0.5)"
          if [ -n "$LATEST_TAG" ]; then
            echo "   Use one of the suggested versions above or follow the same pattern"
          fi
          exit 1
        fi
        echo "âœ… Version format is valid: ${VERSION}"
        
    - name: Check if tag already exists
      run: |
        TAG_NAME="${{ steps.version.outputs.tag_name }}"
        if git rev-parse --verify "refs/tags/${TAG_NAME}" >/dev/null 2>&1; then
          echo "âŒ Error: Tag ${TAG_NAME} already exists!"
          echo "   Please use a different version number."
          exit 1
        fi
        echo "âœ… Tag ${TAG_NAME} does not exist, proceeding with release PR"
        
    - name: Check if release branch already exists
      run: |
        BRANCH_NAME="${{ steps.version.outputs.branch_name }}"
        if git ls-remote --heads origin "${BRANCH_NAME}" | grep -q "${BRANCH_NAME}"; then
          echo "âŒ Error: Branch ${BRANCH_NAME} already exists!"
          echo "   Please use a different version number or delete the existing branch."
          exit 1
        fi
        echo "âœ… Branch ${BRANCH_NAME} does not exist, proceeding with release PR"

  test:
    runs-on: ubuntu-latest
    needs: validate
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      
    - name: Set up JDK 21
      uses: actions/setup-java@v5
      with:
        java-version: '21'
        distribution: 'temurin'
        
    - name: Cache Gradle packages
      uses: actions/cache@v5
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
          
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
      
    - name: Run tests
      run: ./gradlew test
      
    - name: Run ktlint check
      run: ./gradlew ktlintCheck
      
    - name: Build artifacts
      run: ./gradlew build

  create-pr:
    runs-on: ubuntu-latest
    needs: [validate, test]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Create release branch
      run: |
        BRANCH_NAME="${{ needs.validate.outputs.branch_name }}"
        BASE_BRANCH="${{ github.event.inputs.base_branch }}"
        
        echo "ðŸŒ¿ Base branch: ${BASE_BRANCH}"
        git checkout "${BASE_BRANCH}"
        git pull origin "${BASE_BRANCH}"
        
        git checkout -b "${BRANCH_NAME}"
        echo "âœ… Created release branch: ${BRANCH_NAME} from ${BASE_BRANCH}"
        
    - name: Extract build script versions
      id: build_versions
      run: |
        # Extract Kotlin version from build.gradle.kts
        KOTLIN_VERSION=$(grep 'kotlin("jvm") version' build.gradle.kts | sed 's/.*version "\([^"]*\)".*/\1/')
        echo "kotlin_version=${KOTLIN_VERSION}" >> $GITHUB_OUTPUT
        echo "ðŸ“ Extracted Kotlin version: ${KOTLIN_VERSION}"
        
        # Extract KSP version from processor/build.gradle.kts - fix the pattern
        KSP_VERSION=$(grep 'com.google.devtools.ksp:symbol-processing-api:' processor/build.gradle.kts | sed 's/.*symbol-processing-api:\([^"]*\)".*/\1/')
        echo "ksp_version=${KSP_VERSION}" >> $GITHUB_OUTPUT
        echo "ðŸ“ Extracted KSP version: ${KSP_VERSION}"
        
        # Extract kotlin-logging-jvm version from processor/build.gradle.kts
        KOTLIN_LOGGING_VERSION=$(grep 'io.github.oshai:kotlin-logging-jvm:' processor/build.gradle.kts | sed 's/.*kotlin-logging-jvm:\([^"]*\)".*/\1/')
        echo "kotlin_logging_version=${KOTLIN_LOGGING_VERSION}" >> $GITHUB_OUTPUT
        echo "ðŸ“ Extracted kotlin-logging-jvm version: ${KOTLIN_LOGGING_VERSION}"
        
        # Extract full kotlin-logging dependency from processor/build.gradle.kts
        KOTLIN_LOGGING_DEPENDENCY=$(grep 'io.github.oshai:kotlin-logging-jvm:' processor/build.gradle.kts | sed 's/.*"\([^"]*\)".*/\1/')
        echo "kotlin_logging_dependency=${KOTLIN_LOGGING_DEPENDENCY}" >> $GITHUB_OUTPUT
        echo "ðŸ“ Extracted kotlin-logging dependency: ${KOTLIN_LOGGING_DEPENDENCY}"
        
        # Extract logback version from workload/build.gradle.kts
        LOGBACK_VERSION=$(grep 'ch.qos.logback:logback-classic:' workload/build.gradle.kts | sed 's/.*logback-classic:\([^"]*\)".*/\1/')
        echo "logback_version=${LOGBACK_VERSION}" >> $GITHUB_OUTPUT
        echo "ðŸ“ Extracted logback version: ${LOGBACK_VERSION}"

    - name: Update version references
      run: |
        VERSION="${{ needs.validate.outputs.version }}"
        KOTLIN_VERSION="${{ steps.build_versions.outputs.kotlin_version }}"
        KSP_VERSION="${{ steps.build_versions.outputs.ksp_version }}"
        KOTLIN_LOGGING_VERSION="${{ steps.build_versions.outputs.kotlin_logging_version }}"
        KOTLIN_LOGGING_DEPENDENCY="${{ steps.build_versions.outputs.kotlin_logging_dependency }}"
        LOGBACK_VERSION="${{ steps.build_versions.outputs.logback_version }}"
        
        echo "ðŸ“ Updating version references:"
        echo "  - Library version: $VERSION (user input)"
        echo "  - Kotlin version: $KOTLIN_VERSION (from root build.gradle.kts)" 
        echo "  - KSP version: $KSP_VERSION (from processor/build.gradle.kts)"
        echo "  - kotlin-logging-jvm version: $KOTLIN_LOGGING_VERSION (from processor/build.gradle.kts)"
        echo "  - kotlin-logging dependency: $KOTLIN_LOGGING_DEPENDENCY (from processor/build.gradle.kts)"
        echo "  - logback version: $LOGBACK_VERSION (from workload/build.gradle.kts)"
        
        # Create Python script for more reliable version updates
        cat > update_versions.py << 'EOF'
        import re
        import sys
        
        def update_file(file_path, replacements):
            """Update file with multiple replacements"""
            try:
                with open(file_path, 'r', encoding='utf-8') as f:
                    content = f.read()
                
                original_content = content
                
                for replacement_data in replacements:
                    if len(replacement_data) == 3:
                        pattern, replacement, count = replacement_data
                        # Replace specific occurrence
                        matches = list(re.finditer(pattern, content))
                        if len(matches) >= count:
                            # Replace the nth occurrence
                            match = matches[count - 1]
                            content = content[:match.start()] + replacement + content[match.end():]
                    else:
                        pattern, replacement = replacement_data
                        content = re.sub(pattern, replacement, content)
                
                if content != original_content:
                    with open(file_path, 'w', encoding='utf-8') as f:
                        f.write(content)
                    print(f"âœ… Updated {file_path}")
                    return True
                else:
                    print(f"â„¹ï¸  No changes needed in {file_path}")
                    return False
            except Exception as e:
                print(f"âŒ Error updating {file_path}: {e}")
                return False
        
        # Get version variables from environment
        VERSION = sys.argv[1]
        KOTLIN_VERSION = sys.argv[2]
        KSP_VERSION = sys.argv[3]
        KOTLIN_LOGGING_VERSION = sys.argv[4]
        KOTLIN_LOGGING_DEPENDENCY = sys.argv[5]
        LOGBACK_VERSION = sys.argv[6]
        
        # README.md updates
        print("ðŸ”„ Updating README.md...")
        readme_replacements = [
            # Badge updates
            (r'https://img\.shields\.io/badge/kotlin-[0-9]+\.[0-9]+\.[0-9]+-blue\.svg', f'https://img.shields.io/badge/kotlin-{KOTLIN_VERSION}-blue.svg'),
            (r'https://img\.shields\.io/badge/kotlin--logging-[^-]*-green\.svg', 'https://img.shields.io/badge/kotlin--logging-5.0.0+-green.svg'),
            (r'https://img\.shields\.io/badge/KSP-[0-9]+\.[0-9]+\.[0-9]+--[0-9]+\.[0-9]+\.[0-9]+-purple\.svg', f'https://img.shields.io/badge/KSP-{KSP_VERSION.replace("-", "--")}-purple.svg'),
            
            # Dependency examples
            (r'io\.github\.doljae:kotlin-logging-extensions:[0-9]+\.[0-9]+\.[0-9]+(-[0-9]+\.[0-9]+\.[0-9]+)?', f'io.github.doljae:kotlin-logging-extensions:{VERSION}'),
            (r'kotlin\("jvm"\) version "[0-9]+\.[0-9]+\.[0-9]+"', f'kotlin("jvm") version "{KOTLIN_VERSION}"'),
            (r'id\("com\.google\.devtools\.ksp"\) version "[0-9]+\.[0-9]+\.[0-9]+-[0-9]+\.[0-9]+\.[0-9]+"', f'id("com.google.devtools.ksp") version "{KSP_VERSION}"'),
            
            # Version compatibility section
            (r'// For Kotlin [0-9]+\.[0-9]+\.[0-9]+ projects:', f'// For Kotlin {KOTLIN_VERSION} projects:'),
            
            # kotlin-logging version
            (r'io\.github\.oshai:kotlin-logging-jvm:[0-9]+\.[0-9]+\.[0-9]+', f'io.github.oshai:kotlin-logging-jvm:{KOTLIN_LOGGING_VERSION}'),
            
            # logback version
            (r'ch\.qos\.logback:logback-classic:[0-9]+\.[0-9]+\.[0-9]+', f'ch.qos.logback:logback-classic:{LOGBACK_VERSION}'),
        ]
        
        update_file('README.md', readme_replacements)
        
        # Add new version to compatibility table if not exists
        try:
            with open('README.md', 'r', encoding='utf-8') as f:
                readme_content = f.read()
            
            if f"| `{VERSION}` |" not in readme_content:
                # Find separator line and add new row after it
                pattern = r'(\|---------+\|--------+\|-----+\|)'
                replacement = f'\\1\n| `{VERSION}` | `{KOTLIN_VERSION}` | `{KSP_VERSION}` |'
                updated_content = re.sub(pattern, replacement, readme_content)
                
                if updated_content != readme_content:
                    with open('README.md', 'w', encoding='utf-8') as f:
                        f.write(updated_content)
                    print(f"âœ… Added new version row: {VERSION}")
                else:
                    print(f"â„¹ï¸  Version {VERSION} already exists in compatibility table")
        except Exception as e:
            print(f"âŒ Error updating compatibility table: {e}")
        
        # Update issue templates - use simpler approach for placeholders
        templates = [
            ('bug_report.yml', [
                (r'io\.github\.doljae:kotlin-logging-extensions:[0-9]+\.[0-9]+\.[0-9]+(-[0-9]+\.[0-9]+\.[0-9]+)?', f'io.github.doljae:kotlin-logging-extensions:{VERSION}'),
                (r'kotlin\("jvm"\) version "[0-9]+\.[0-9]+\.[0-9]+"', f'kotlin("jvm") version "{KOTLIN_VERSION}"'),
                (r'id\("com\.google\.devtools\.ksp"\) version "[0-9]+\.[0-9]+\.[0-9]+-[0-9]+\.[0-9]+\.[0-9]+"', f'id("com.google.devtools.ksp") version "{KSP_VERSION}"'),
                (r'ch\.qos\.logback:logback-classic:[0-9]+\.[0-9]+\.[0-9]+', f'ch.qos.logback:logback-classic:{LOGBACK_VERSION}'),
                (r'placeholder: "e\.g\., [^"]*"', f'placeholder: "e.g., {VERSION}"', 1),  # First occurrence
                (r'placeholder: "e\.g\., [^"]*"', f'placeholder: "e.g., {KOTLIN_VERSION}"', 2),  # Second occurrence
                (r'placeholder: "e\.g\., [^"]*"', f'placeholder: "e.g., {KSP_VERSION}"', 3),  # Third occurrence
                (r'placeholder: "e\.g\., [^"]*"', f'placeholder: "e.g., {KOTLIN_LOGGING_DEPENDENCY}"', 4),  # Fourth occurrence
            ]),
            ('version_compatibility.yml', [
                (r'placeholder: "e\.g\., [^"]*"', f'placeholder: "e.g., {VERSION}"', 1),
                (r'placeholder: "e\.g\., [^"]*"', f'placeholder: "e.g., {KOTLIN_VERSION}"', 2),
                (r'placeholder: "e\.g\., [^"]*"', f'placeholder: "e.g., {KSP_VERSION}"', 3),
                (r'placeholder: "e\.g\., [^"]*"', f'placeholder: "e.g., {KOTLIN_LOGGING_DEPENDENCY}"', 4),
            ]),
            ('question.yml', [
                (r'placeholder: "e\.g\., [^"]*"', f'placeholder: "e.g., {VERSION}"', 1),
                (r'placeholder: "e\.g\., [^"]*"', f'placeholder: "e.g., {KOTLIN_LOGGING_DEPENDENCY}"', 2),
            ]),
        ]
        
        for template_file, replacements in templates:
            print(f"ðŸ”„ Updating {template_file}...")
            update_file(f'.github/ISSUE_TEMPLATE/{template_file}', replacements)
        
        # Update gradle.properties
        print("ðŸ”„ Updating gradle.properties...")
        update_file('gradle.properties', [
            (r'project\.version=.*', f'project.version={VERSION}')
        ])
        
        print("âœ… Version references updated successfully")
        EOF
        
        # Run the Python script
        python3 update_versions.py "$VERSION" "$KOTLIN_VERSION" "$KSP_VERSION" "$KOTLIN_LOGGING_VERSION" "$KOTLIN_LOGGING_DEPENDENCY" "$LOGBACK_VERSION"
        
        # Log what was updated
        echo "ðŸ“‹ Updated files:"
        echo "  - README.md (badges + dependency examples + build script versions + version compatibility table)"
        echo "  - .github/ISSUE_TEMPLATE/bug_report.yml (code blocks + placeholders)" 
        echo "  - .github/ISSUE_TEMPLATE/version_compatibility.yml (placeholders)"
        echo "  - .github/ISSUE_TEMPLATE/question.yml (placeholder)"
        echo "  - gradle.properties (project version)"
        echo ""
        echo "ðŸ“Œ Version updates applied:"
        echo "  - Library Version: $VERSION (user input)"
        echo "  - Kotlin Version: $KOTLIN_VERSION (from root build.gradle.kts)"
        echo "  - KSP Version: $KSP_VERSION (from processor/build.gradle.kts)"
        echo "  - kotlin-logging-jvm Version: $KOTLIN_LOGGING_VERSION (from processor/build.gradle.kts)"
        echo "  - kotlin-logging Dependency: $KOTLIN_LOGGING_DEPENDENCY (from processor/build.gradle.kts)"
        echo "  - logback Version: $LOGBACK_VERSION (from workload/build.gradle.kts)"

    - name: Commit version updates
      run: |
        VERSION="${{ needs.validate.outputs.version }}"
        KOTLIN_VERSION="${{ steps.build_versions.outputs.kotlin_version }}"
        KSP_VERSION="${{ steps.build_versions.outputs.ksp_version }}"
        KOTLIN_LOGGING_VERSION="${{ steps.build_versions.outputs.kotlin_logging_version }}"
        KOTLIN_LOGGING_DEPENDENCY="${{ steps.build_versions.outputs.kotlin_logging_dependency }}"
        LOGBACK_VERSION="${{ steps.build_versions.outputs.logback_version }}"
        
        # Configure git user
        git config user.name "Seokjae Lee"
        git config user.email "seok9211@naver.com"
        
        # Add changed files
        git add README.md gradle.properties .github/ISSUE_TEMPLATE/
        
        # Check if there are changes to commit
        if git diff --staged --quiet; then
          echo "âš ï¸ No version changes to commit - files may already be up to date"
          echo "Current gradle.properties version: $(grep 'project.version=' gradle.properties)"
          echo "Target versions: Library=$VERSION, Kotlin=$KOTLIN_VERSION, KSP=$KSP_VERSION, kotlin-logging-jvm=$KOTLIN_LOGGING_VERSION"
          
          # Still commit to ensure the release branch has something
          echo "Creating empty commit to ensure release branch exists..."
          git commit --allow-empty -m "chore: prepare release $VERSION" \
            -m "No version changes needed - files already up to date" \
            -m "Target versions:" \
            -m "  * Library Version â†’ $VERSION" \
            -m "  * Kotlin Version â†’ $KOTLIN_VERSION" \
            -m "  * KSP Version â†’ $KSP_VERSION" \
            -m "  * kotlin-logging-jvm Version â†’ $KOTLIN_LOGGING_VERSION" \
            -m "  * kotlin-logging Dependency â†’ $KOTLIN_LOGGING_DEPENDENCY" \
            -m "  * logback Version â†’ $LOGBACK_VERSION"
          echo "âœ… Empty commit created for release branch"
        else
          # Commit changes
          git commit -m "chore: update version references to $VERSION" \
            -m "- Update README.md badges, dependency examples, build script versions and version compatibility" \
            -m "- Update issue template placeholders with build script versions:" \
            -m "  * Library Version â†’ $VERSION" \
            -m "  * Kotlin Version â†’ $KOTLIN_VERSION" \
            -m "  * KSP Version â†’ $KSP_VERSION" \
            -m "  * kotlin-logging-jvm Version â†’ $KOTLIN_LOGGING_VERSION" \
            -m "  * kotlin-logging Dependency â†’ $KOTLIN_LOGGING_DEPENDENCY" \
            -m "  * logback Version â†’ $LOGBACK_VERSION" \
            -m "- Update project version in gradle.properties"
          echo "âœ… Version updates committed"
          
          # Show what was changed
          echo "ðŸ“‹ Changed files:"
          git diff --name-only HEAD~1 HEAD | sed 's/^/  - /'
        fi
        
    - name: Push release branch
      run: |
        BRANCH_NAME="${{ needs.validate.outputs.branch_name }}"
        git push origin "${BRANCH_NAME}"
        echo "âœ… Pushed release branch: ${BRANCH_NAME}"
        
    - name: Generate release notes for PR
      id: release_notes
      run: |
        # Get the previous tag
        PREVIOUS_TAG=$(git tag --sort=-version:refname | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+-[0-9]+\.[0-9]+\.[0-9]+$' | head -1)
        CURRENT_VERSION="${{ needs.validate.outputs.version }}"
        
        echo "Generating release notes since ${PREVIOUS_TAG}"
        
        # Create PR description
        echo "## ðŸš€ Release ${{ needs.validate.outputs.tag_name }}" > pr_description.md
        echo "" >> pr_description.md
        echo "This PR prepares the release of version \`${CURRENT_VERSION}\`." >> pr_description.md
        echo "" >> pr_description.md
        
        if [ -z "$PREVIOUS_TAG" ]; then
          # First release
          echo "### ðŸŽ‰ Initial Release" >> pr_description.md
          echo "" >> pr_description.md
          echo "This is the first release of kotlin-logging-extensions!" >> pr_description.md
          echo "" >> pr_description.md
          echo "**Features:**" >> pr_description.md
          echo "- Automatic logger generation for Kotlin classes using KSP" >> pr_description.md
          echo "- Zero boilerplate - just use \`log.info { }\` in any class" >> pr_description.md
          echo "- Package-aware naming with fully qualified class names" >> pr_description.md
          echo "- Seamless integration with kotlin-logging library" >> pr_description.md
          echo "" >> pr_description.md
        else
          # Regular release
          echo "### ðŸ“ Changes since ${PREVIOUS_TAG}" >> pr_description.md
          echo "" >> pr_description.md
          
          # Get commits since last tag and categorize them
          ALL_COMMITS=$(git log ${PREVIOUS_TAG}..HEAD~1 --pretty=format:"%s (%h)	%an	%ae" --no-merges)
          
          # Initialize categories
          FEATURES_FIXES=""
          VERSION_DEPS=""
          DOCS_MAINTENANCE=""
          
          while IFS= read -r line; do
            if [ -n "$line" ]; then
              COMMIT_MSG=$(echo "$line" | cut -d$'\t' -f1)
              AUTHOR_NAME=$(echo "$line" | cut -d$'\t' -f2)
              AUTHOR_EMAIL=$(echo "$line" | cut -d$'\t' -f3)
              
              echo "  Categorizing: $COMMIT_MSG"
              
                             # Categorize commits
               if [[ "$COMMIT_MSG" == fix\(deps\):* ]] || [[ "$COMMIT_MSG" == fix\(dep\):* ]] || 
                  ([[ "$COMMIT_MSG" == chore:* ]] || [[ "$COMMIT_MSG" == ci:* ]]) && 
                  ([[ "$COMMIT_MSG" == *update* ]] || [[ "$COMMIT_MSG" == *upgrade* ]] || [[ "$COMMIT_MSG" == *bump* ]]) && 
                  ([[ "$COMMIT_MSG" == *dependency* ]] || [[ "$COMMIT_MSG" == *dependencies* ]] || [[ "$COMMIT_MSG" == *deps* ]] || 
                   [[ "$COMMIT_MSG" == *version* ]] || [[ "$COMMIT_MSG" == *kotlin* ]] || [[ "$COMMIT_MSG" == *ksp* ]] || [[ "$COMMIT_MSG" == *gradle* ]]); then
                 # Version & Dependency updates (check this first)
                 VERSION_DEPS="${VERSION_DEPS}- ${COMMIT_MSG}"$'\n'
                 echo "    â†’ Dependencies & Versions"
               elif [[ "$COMMIT_MSG" == feat:* ]] || [[ "$COMMIT_MSG" == fix:* ]] || [[ "$COMMIT_MSG" == perf:* ]] || [[ "$COMMIT_MSG" == refactor:* ]]; then
                 # Features & Fixes
                 FEATURES_FIXES="${FEATURES_FIXES}- ${COMMIT_MSG}"$'\n'
                 echo "    â†’ Features & Fixes"
               elif [[ "$COMMIT_MSG" == docs:* ]] || [[ "$COMMIT_MSG" == chore:* ]] || [[ "$COMMIT_MSG" == ci:* ]] || [[ "$COMMIT_MSG" == style:* ]] || [[ "$COMMIT_MSG" == test:* ]]; then
                 # Documentation & Maintenance
                 DOCS_MAINTENANCE="${DOCS_MAINTENANCE}- ${COMMIT_MSG}"$'\n'
                 echo "    â†’ Documentation & Maintenance"
               else
                 # Uncategorized - put in Features & Fixes as default
                 FEATURES_FIXES="${FEATURES_FIXES}- ${COMMIT_MSG}"$'\n'
                 echo "    â†’ Features & Fixes (default)"
               fi
            fi
          done <<< "$ALL_COMMITS"
          
          # Build categorized commit list
          if [ -n "$FEATURES_FIXES" ] || [ -n "$VERSION_DEPS" ] || [ -n "$DOCS_MAINTENANCE" ]; then
            # Features & Fixes
            if [ -n "$FEATURES_FIXES" ]; then
              echo "#### ðŸš€ Features & Fixes" >> pr_description.md
              echo "$FEATURES_FIXES" >> pr_description.md
            fi
            
            # Dependencies & Versions
            if [ -n "$VERSION_DEPS" ]; then
              echo "#### ðŸ“¦ Dependencies & Versions" >> pr_description.md
              echo "$VERSION_DEPS" >> pr_description.md
            fi
            
            # Documentation & Maintenance
            if [ -n "$DOCS_MAINTENANCE" ]; then
              echo "#### ðŸ“š Documentation & Maintenance" >> pr_description.md
              echo "$DOCS_MAINTENANCE" >> pr_description.md
            fi
            

          else
            echo "- No significant changes" >> pr_description.md
            echo "" >> pr_description.md
          fi
        fi
        
        # Add version compatibility info (using extracted build script versions)
        KOTLIN_VERSION="${{ steps.build_versions.outputs.kotlin_version }}"
        KSP_VERSION="${{ steps.build_versions.outputs.ksp_version }}"
        KOTLIN_LOGGING_VERSION="${{ steps.build_versions.outputs.kotlin_logging_version }}"
        
        echo "### âš¡ Version Compatibility" >> pr_description.md
        echo "- **Kotlin**: $KOTLIN_VERSION" >> pr_description.md
        echo "- **KSP**: $KSP_VERSION" >> pr_description.md
        echo "- **kotlin-logging**: 5.0.0+" >> pr_description.md
        echo "" >> pr_description.md
        
        # Add what will happen after merge
        echo "### ðŸ”„ After Merge" >> pr_description.md
        echo "When this PR is merged, the following will happen automatically:" >> pr_description.md
        echo "- âœ… Create git tag: \`${{ needs.validate.outputs.tag_name }}\`" >> pr_description.md
        echo "- âœ… Generate GitHub Release with release notes" >> pr_description.md
        echo "- âœ… Automatically publish to Maven Central" >> pr_description.md
        echo "" >> pr_description.md
        
        # Add review checklist
        echo "### âœ… Review Checklist" >> pr_description.md
        echo "- [ ] Version number is correct" >> pr_description.md
        echo "- [ ] All version references are updated consistently" >> pr_description.md
        echo "- [ ] Tests are passing" >> pr_description.md
        echo "- [ ] Ready to release" >> pr_description.md
        
        # Set output for PR creation
        echo 'pr_description<<EOF' >> $GITHUB_OUTPUT
        cat pr_description.md >> $GITHUB_OUTPUT
        echo 'EOF' >> $GITHUB_OUTPUT
        
    - name: Create Pull Request using GitHub CLI
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        VERSION="${{ needs.validate.outputs.version }}"
        TAG_NAME="${{ needs.validate.outputs.tag_name }}"
        BRANCH_NAME="${{ needs.validate.outputs.branch_name }}"
        
        # Save PR description to file for GitHub CLI
        cat > pr_body.md << 'EOF'
        ${{ steps.release_notes.outputs.pr_description }}
        EOF
        
        # Create PR using GitHub CLI (preserves all commits in branch)
        echo "ðŸ”„ Creating Pull Request from branch ${BRANCH_NAME} to ${{ github.event.inputs.base_branch }}..."
        PR_URL=$(gh pr create \
          --title "Release ${TAG_NAME}" \
          --body-file pr_body.md \
          --base "${{ github.event.inputs.base_branch }}" \
          --head "${BRANCH_NAME}" \
          --assignee doljae \
          --reviewer doljae)
        
        echo "âœ… Pull Request created: ${PR_URL}"
        
        # Try to add labels (may fail if labels don't exist)
        PR_NUMBER=$(basename "${PR_URL}")
        gh pr edit "${PR_NUMBER}" --add-label "release" || echo "âš ï¸ Could not add 'release' label"
        gh pr edit "${PR_NUMBER}" --add-label "version-update" || echo "âš ï¸ Could not add 'version-update' label"
        
        # Clean up temporary files
        rm -f pr_body.md pr_description.md
        
    - name: Summary
      run: |
        VERSION="${{ needs.validate.outputs.version }}"
        KOTLIN_VERSION="${{ steps.build_versions.outputs.kotlin_version }}"
        KSP_VERSION="${{ steps.build_versions.outputs.ksp_version }}"
        KOTLIN_LOGGING_VERSION="${{ steps.build_versions.outputs.kotlin_logging_version }}"
        KOTLIN_LOGGING_DEPENDENCY="${{ steps.build_versions.outputs.kotlin_logging_dependency }}"
        LOGBACK_VERSION="${{ steps.build_versions.outputs.logback_version }}"
        TAG_NAME="${{ needs.validate.outputs.tag_name }}"
        BRANCH_NAME="${{ needs.validate.outputs.branch_name }}"
        
        echo "ðŸŽ‰ Release PR created successfully!"
        echo ""
        echo "ðŸ“¦ Library Version: $VERSION (user input)"
        echo "âš¡ Kotlin Version: $KOTLIN_VERSION (root build.gradle.kts)"
        echo "ðŸ”§ KSP Version: $KSP_VERSION (processor/build.gradle.kts)"
        echo "ðŸ“š kotlin-logging-jvm Version: $KOTLIN_LOGGING_VERSION (processor/build.gradle.kts)"
        echo "ðŸ”— kotlin-logging Dependency: $KOTLIN_LOGGING_DEPENDENCY (processor/build.gradle.kts)"
        echo "ðŸ“‹ logback Version: $LOGBACK_VERSION (workload/build.gradle.kts)"
        echo "ðŸ·ï¸ Tag: $TAG_NAME"
        echo "ðŸŒ¿ Branch: $BRANCH_NAME"
        echo ""
        echo "ðŸ“ Updated placeholders in issue templates with extracted build script versions"
        echo ""
        echo "ðŸ”— Review and merge the PR to trigger automatic release:"
        echo "   https://github.com/${{ github.repository }}/pulls"
        echo ""
        echo "â„¹ï¸ After PR merge, check the auto-release workflow:"
        echo "   https://github.com/${{ github.repository }}/actions" 
