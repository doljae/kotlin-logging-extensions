name: Create Release PR

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (KSP format: KOTLIN_VERSION-LIB_VERSION, e.g., 2.1.21-0.0.2)'
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  validate:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag_name: ${{ steps.version.outputs.tag_name }}
      branch_name: ${{ steps.version.outputs.branch_name }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Set version variables
      id: version
      run: |
        VERSION="${{ github.event.inputs.version }}"
        TAG_NAME="v${VERSION}"
        BRANCH_NAME="release/${VERSION}"
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "tag_name=${TAG_NAME}" >> $GITHUB_OUTPUT
        echo "branch_name=${BRANCH_NAME}" >> $GITHUB_OUTPUT
        echo "Version: ${VERSION}"
        echo "Tag: ${TAG_NAME}"
        echo "Branch: ${BRANCH_NAME}"
        
    - name: Validate version format
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        if [[ ! $VERSION =~ ^[0-9]+\.[0-9]+\.[0-9]+-[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
          echo "âŒ Error: Version must be in KSP format KOTLIN_VERSION-LIB_VERSION (e.g., 2.1.21-0.0.1)"
          echo "   Input version: ${VERSION}"
          echo "   Expected format: KOTLIN_VERSION-LIB_VERSION (e.g., 2.1.21-0.0.1)"
          exit 1
        fi
        echo "âœ… Version format is valid: ${VERSION}"
        
    - name: Check if tag already exists
      run: |
        TAG_NAME="${{ steps.version.outputs.tag_name }}"
        if git rev-parse --verify "refs/tags/${TAG_NAME}" >/dev/null 2>&1; then
          echo "âŒ Error: Tag ${TAG_NAME} already exists!"
          echo "   Please use a different version number."
          exit 1
        fi
        echo "âœ… Tag ${TAG_NAME} does not exist, proceeding with release PR"
        
    - name: Check if release branch already exists
      run: |
        BRANCH_NAME="${{ steps.version.outputs.branch_name }}"
        if git ls-remote --heads origin "${BRANCH_NAME}" | grep -q "${BRANCH_NAME}"; then
          echo "âŒ Error: Branch ${BRANCH_NAME} already exists!"
          echo "   Please use a different version number or delete the existing branch."
          exit 1
        fi
        echo "âœ… Branch ${BRANCH_NAME} does not exist, proceeding with release PR"

  test:
    runs-on: ubuntu-latest
    needs: validate
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        
    - name: Cache Gradle packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
          
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
      
    - name: Run tests
      run: ./gradlew test
      
    - name: Run ktlint check
      run: ./gradlew ktlintCheck
      
    - name: Build artifacts
      run: ./gradlew build

  create-pr:
    runs-on: ubuntu-latest
    needs: [validate, test]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Create release branch
      run: |
        BRANCH_NAME="${{ needs.validate.outputs.branch_name }}"
        git checkout -b "${BRANCH_NAME}"
        echo "âœ… Created release branch: ${BRANCH_NAME}"
        
    - name: Update version references
      run: |
        VERSION="${{ needs.validate.outputs.version }}"
        echo "ðŸ“ Updating version references to: $VERSION"
        
        # Update README.md (4 locations)
        sed -i "s/io\.github\.doljae:kotlin-logging-extensions:[0-9]\+\.[0-9]\+\.[0-9]\+-[0-9]\+\.[0-9]\+\.[0-9]\+/io.github.doljae:kotlin-logging-extensions:$VERSION/g" README.md
        
        # Update issue templates (2 locations in bug_report.yml)
        sed -i "s/io\.github\.doljae:kotlin-logging-extensions:[0-9]\+\.[0-9]\+\.[0-9]\+-[0-9]\+\.[0-9]\+\.[0-9]\+/io.github.doljae:kotlin-logging-extensions:$VERSION/g" .github/ISSUE_TEMPLATE/bug_report.yml
        
        # Update example versions in all issue templates
        find .github/ISSUE_TEMPLATE/ -name "*.yml" -exec sed -i "s/e\.g\., [0-9]\+\.[0-9]\+\.[0-9]\+-[0-9]\+\.[0-9]\+\.[0-9]\+/e.g., $VERSION/g" {} \;
        
        # Update gradle.properties
        sed -i "s/project.version=.*/project.version=$VERSION/" gradle.properties
        
        echo "âœ… Version references updated successfully"

    - name: Commit version updates
      run: |
        VERSION="${{ needs.validate.outputs.version }}"
        
        # Configure git user
        git config user.name "Seokjae Lee"
        git config user.email "seok9211@naver.com"
        
        # Add changed files
        git add README.md gradle.properties .github/ISSUE_TEMPLATE/
        
        # Check if there are changes to commit
        if git diff --staged --quiet; then
          echo "â„¹ï¸ No version changes to commit"
          exit 1
        else
          # Commit changes
          git commit -m "chore: update version references to $VERSION" -m "- Update README.md dependency examples" -m "- Update issue template version examples" -m "- Update project version in gradle.properties"
          echo "âœ… Version updates committed"
        fi
        
    - name: Push release branch
      run: |
        BRANCH_NAME="${{ needs.validate.outputs.branch_name }}"
        git push origin "${BRANCH_NAME}"
        echo "âœ… Pushed release branch: ${BRANCH_NAME}"
        
    - name: Generate release notes for PR
      id: release_notes
      run: |
        # Get the previous tag
        PREVIOUS_TAG=$(git tag --sort=-version:refname | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+-[0-9]+\.[0-9]+\.[0-9]+$' | head -1)
        CURRENT_VERSION="${{ needs.validate.outputs.version }}"
        
        echo "Generating release notes since ${PREVIOUS_TAG}"
        
        # Create PR description
        echo "## ðŸš€ Release ${{ needs.validate.outputs.tag_name }}" > pr_description.md
        echo "" >> pr_description.md
        echo "This PR prepares the release of version \`${CURRENT_VERSION}\`." >> pr_description.md
        echo "" >> pr_description.md
        
        if [ -z "$PREVIOUS_TAG" ]; then
          # First release
          echo "### ðŸŽ‰ Initial Release" >> pr_description.md
          echo "" >> pr_description.md
          echo "This is the first release of kotlin-logging-extensions!" >> pr_description.md
          echo "" >> pr_description.md
          echo "**Features:**" >> pr_description.md
          echo "- Automatic logger generation for Kotlin classes using KSP" >> pr_description.md
          echo "- Zero boilerplate - just use \`log.info { }\` in any class" >> pr_description.md
          echo "- Package-aware naming with fully qualified class names" >> pr_description.md
          echo "- Seamless integration with kotlin-logging library" >> pr_description.md
          echo "" >> pr_description.md
        else
          # Regular release
          echo "### ðŸ“ Changes since ${PREVIOUS_TAG}" >> pr_description.md
          echo "" >> pr_description.md
          
          # Get commits since last tag
          COMMITS=$(git log ${PREVIOUS_TAG}..HEAD~1 --pretty=format:"- %s (%h)" --no-merges)
          if [ -n "$COMMITS" ]; then
            echo "$COMMITS" >> pr_description.md
            echo "" >> pr_description.md
          else
            echo "- Minor improvements and updates" >> pr_description.md
            echo "" >> pr_description.md
          fi
        fi
        
        # Add version compatibility info
        echo "### âš¡ Version Compatibility" >> pr_description.md
        echo "- **Kotlin**: 2.1.21" >> pr_description.md
        echo "- **KSP**: 2.1.21-2.0.2" >> pr_description.md
        echo "- **kotlin-logging**: 7.0.7+" >> pr_description.md
        echo "" >> pr_description.md
        
        # Add what will happen after merge
        echo "### ðŸ”„ After Merge" >> pr_description.md
        echo "When this PR is merged, the following will happen automatically:" >> pr_description.md
        echo "- âœ… Create git tag: \`${{ needs.validate.outputs.tag_name }}\`" >> pr_description.md
        echo "- âœ… Generate GitHub Release with release notes" >> pr_description.md
        echo "- âœ… Upload to Maven Central staging repository" >> pr_description.md
        echo "- âš ï¸ Manual step: Complete publishing at https://oss.sonatype.org/" >> pr_description.md
        echo "" >> pr_description.md
        
        # Add review checklist
        echo "### âœ… Review Checklist" >> pr_description.md
        echo "- [ ] Version number is correct" >> pr_description.md
        echo "- [ ] All version references are updated consistently" >> pr_description.md
        echo "- [ ] Tests are passing" >> pr_description.md
        echo "- [ ] Ready to release" >> pr_description.md
        
        # Set output for PR creation
        echo 'pr_description<<EOF' >> $GITHUB_OUTPUT
        cat pr_description.md >> $GITHUB_OUTPUT
        echo 'EOF' >> $GITHUB_OUTPUT
        
    - name: Create Pull Request using GitHub CLI
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        VERSION="${{ needs.validate.outputs.version }}"
        TAG_NAME="${{ needs.validate.outputs.tag_name }}"
        BRANCH_NAME="${{ needs.validate.outputs.branch_name }}"
        
        # Save PR description to file for GitHub CLI
        cat > pr_body.md << 'EOF'
        ${{ steps.release_notes.outputs.pr_description }}
        EOF
        
        # Create PR using GitHub CLI (preserves all commits in branch)
        echo "ðŸ”„ Creating Pull Request from branch ${BRANCH_NAME} to main..."
        PR_URL=$(gh pr create \
          --title "Release ${TAG_NAME}" \
          --body-file pr_body.md \
          --base main \
          --head "${BRANCH_NAME}" \
          --assignee doljae \
          --reviewer doljae)
        
        echo "âœ… Pull Request created: ${PR_URL}"
        
        # Try to add labels (may fail if labels don't exist)
        PR_NUMBER=$(basename "${PR_URL}")
        gh pr edit "${PR_NUMBER}" --add-label "release" || echo "âš ï¸ Could not add 'release' label"
        gh pr edit "${PR_NUMBER}" --add-label "version-update" || echo "âš ï¸ Could not add 'version-update' label"
        
        # Clean up temporary files
        rm -f pr_body.md pr_description.md
        
    - name: Summary
      run: |
        echo "ðŸŽ‰ Release PR created successfully!"
        echo ""
        echo "ðŸ“¦ Version: ${{ needs.validate.outputs.version }}"
        echo "ðŸ·ï¸ Tag: ${{ needs.validate.outputs.tag_name }}"
        echo "ðŸŒ¿ Branch: ${{ needs.validate.outputs.branch_name }}"
        echo ""
        echo "ðŸ”— Review and merge the PR to trigger automatic release:"
        echo "   https://github.com/${{ github.repository }}/pulls"
        echo ""
        echo "â„¹ï¸ After PR merge, check the auto-release workflow:"
        echo "   https://github.com/${{ github.repository }}/actions" 
